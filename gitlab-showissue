#!/usr/bin/env python3

# Copyright Â© 2022 Jakub Wilk <jwilk@jwilk.net>
# SPDX-License-Identifier: MIT

import argparse
import html.parser
import io
import json
import re
import urllib.parse
import urllib.request

0_0  # Python >= 3.6 is required

user_agent = 'gitlab-toolbox (https://github.com/jwilk/gitlab-toolbox)'

def wget(url):
    headers = {'User-Agent': user_agent}
    request = urllib.request.Request(url, headers=headers)
    return urllib.request.urlopen(request)

def wget_json(url):
    with wget(url) as fp:
        with io.TextIOWrapper(fp, encoding='UTF-8') as tfp:
            return json.load(tfp, object_hook=DictProxy)

class DictProxy(object):

    def __init__(self, d):
        self._d = d

    def __getattr__(self, attr):
        return self._d[attr]

def fmt_date(d):
    d = re.sub('[.]\d+', '', d)
    d = d.replace('T', ' ')
    return d

def fmt_user(user, url):
    url = urllib.request.urljoin(url, user.path)
    username = user.username
    return f'{username} <{url}>'

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument('url', metavar='URL')
    opts = ap.parse_args()
    author = None
    class HTMLParser(html.parser.HTMLParser):
        def handle_starttag(self, tag, attrs):
            nonlocal author
            if tag == 'a':
                attrs = dict(attrs)
                classes = attrs.get('class', '').split()
                if 'author-link' in classes:
                    userurl = urllib.request.urljoin(opts.url, attrs['href'])
                    username = attrs['data-name']
                    author = f'{username} <{userurl}>'
    html_parser = HTMLParser()
    with wget(opts.url) as fp:
        with io.TextIOWrapper(fp, encoding='UTF-8') as tfp:
            data = tfp.read()
        html_parser.feed(data)
    jurl = f'{opts.url}.json'
    data = wget_json(jurl)
    print('Location:', urllib.parse.urljoin(opts.url, data.web_url))
    if author:
        print('From:', author)
    print('Title:', data.title)
    print('Type:', data.type)
    print('Created-At:', fmt_date(data.created_at))
    print('Updated-At:', fmt_date(data.updated_at))
    labels = [label.title for label in data.labels]
    if labels:
        print('Labels:', *labels)
    print()
    print(data.description)
    jurl = f'{opts.url}/discussions.json'
    data = wget_json(jurl)
    for item in data:
        for note in item.notes:
            print()
            print('-' * 72)
            url = note.noteable_note_url
            if url:
                print('Location:', url)
            print('From:', fmt_user(note.author, url or jurl))
            print()
            print(note.note)

if __name__ == '__main__':
    main()

# vim:ts=4 sts=4 sw=4 et
